<link rel="stylesheet" href="/static/css/post.css">
<link rel="stylesheet" href="/static/css/delete_button.css"/>

    <div id="container">

      <button id="back-to-feed" onclick="history.back()">⬅️ Back to Feed</button>

      <!-- Single Post -->
      {{> individual_post hideCommentButton=true unicoPost=true}}

      <!-- Comments Section -->
      <div id="comments-section">
        <h2>Comments</h2>
        {{#if comments}}
        {{#each comments}}
        <!-- Existing Comment -->
        <div class="comment">
          {{#if is_own}}
          <button class="delete-button" onclick="deleteComment('{{comment_id}}')">
            <img class="delete-icon" src="/static/assets/delete.svg" alt="Delete" />
          </button>
          {{/if}}
          <div class="comment-user">
            <a href="{{username_comment}}/profile"><strong>@{{username_comment}}</strong></a>:
          </div>
          <div class="comment-content">
            {{content}}
          </div>
        </div>

        {{/each}}
        {{else}}
        <p>No comments yet. Add one yourself!</p>
        {{/if}}
        {{#if loggedIn}}
        <!-- New Comment Form -->
        <form id="new-comment-form" action="/post/{{post_id}}/comment" method="post">
          <textarea name="comment-content" placeholder="Add a comment..." required></textarea>
          <button type="submit">Post Comment</button>
        </form>
        {{/if}}
    </div>
  </div>

<script>
  document.getElementById('new-comment-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const formData = new FormData(event.target);    
    const urlEncodedData = new URLSearchParams(formData).toString();

    fetch(`/post/{{post_id}}/comment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: urlEncodedData
    }).then((response) => {
      if (response.ok)
        window.location.reload();
      else 
        response.text().then((text) => 
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: `Error: ${text}`
          })
        );
    }).catch((error) => {
      console.error('Error:', error);
    });
  });


  function deleteComment(comment_id) {
    Swal.fire({
      title: 'Are you sure you want to delete this comment?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        deleteCommentConfirmed(comment_id);
      }
    });

  }

  function deleteCommentConfirmed(comment_id) {
    fetch(`/post/{{post_id}}/comment/${comment_id}`, {
      method: 'DELETE',
    }).then((response) => {
      if (response.ok)
        window.location.reload();
      else 
        response.text().then((text) => 
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: `Error: ${text}`
          })
        );
    }).catch((error) => {
      console.error('Error:', error);
    });
  }
</script>


<script src="/static/js/updateLikes.js" type="text/javascript"></script>
<script src="/static/js/like.js" type="text/javascript" event_listener_location="container"></script>
