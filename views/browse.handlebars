<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{title}}</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link href="{{style}}" rel="stylesheet" type="text/css" media="all">
</head>
<body>
  <div id="navbar">
    <div id="logo"><a href="/">Logo!</a></div>
    <div id="user-info">
      {{#if loggedIn}}
        <span>Welcome, {{username}}!</span>
        <a href="/logout">Logout</a>
      {{else}}
        <a href="/login">Login</a>
      {{/if}}
    </div>
  </div>
  <div id="browse-container">
  <h1>Browse Books</h1>
  <input type="text" id="search-input" placeholder="Search for a book"/>

  <div id="book-list">
    <label for="book-select">Select a book:</label>
    <select name="book" id="book-select" style="width: 100%;">
      <option value="">-- Select a book --</option>
      {{#each bookEntries}}
        <option value="{{this.id}}">{{this.book_name}}</option>
      {{/each}}
    </select>
  </div>
  
  <button type="submit" onclick="return redirectToBook(event)">View Book</button>
</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script>
    $(document).ready(function() {
      $('#book-select').select2({
        placeholder: "-- Select a book --"
      });

      let debounceTimeout;
      const debounceDelay = 300; 

      document.getElementById('search-input').addEventListener('input', function() {
        clearTimeout(debounceTimeout); 
        const searchTerm = this.value;

        
        if (searchTerm.length < 1) {
          return;
        }

     
        debounceTimeout = setTimeout(() => {
          fetch(`/browse/search?search=${encodeURIComponent(searchTerm)}`)
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error('Network response was not ok.');
              }
            })
            .then((data) => {
        
              const select = document.getElementById('book-select');
              select.innerHTML = '<option value="">-- Select a book --</option>'; 

              data.bookEntries.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                console.log(book.book_name);
                option.textContent = book.book_name;
                select.appendChild(option);
              });

            
              $('#book-select').select2();
            })
            .catch((error) => console.error("Error fetching books:", error));
        }, debounceDelay);
      });
    });

    function redirectToBook(event) {
      event.preventDefault(); 
      const select = document.getElementById('book-select');
      const bookId = select.value;
      if (bookId) {
        window.location.href = `/book/${bookId}`;
      } else {
        alert("Please select a book."); 
      }
    }
  </script>
</body>
</html>